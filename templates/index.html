<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>강릉 여행지 검색</title>
    <script src="https://openapi.map.naver.com/openapi/v3/maps.js?ncpClientId=l10kq6x6md"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body>
    <h1>강릉 여행지 검색</h1>
    <div class="search-container">
        <form method="POST">
            <input type="text" name="query" placeholder="검색어를 입력하세요">
            <button type="submit">검색</button>
        </form>
    </div>

    <div class="container">
        <!-- 왼쪽: 선택된 여행지 -->
        <div id="travelListContainer">
            <h3>선택된 여행지</h3>
            <ul id="travelList">
                {% for place in selected_places %}
                    <li>
                        {{ place.name }} 
                        <label>
                            <!-- 체크박스 상태가 변경될 때마다 updateCategory 호출 -->
                            <input type="checkbox" 
                            name="category_{{ place.name }}" 
                            value="1" 
                            {% if place.category == "1" %} checked {% endif %} 
                            onchange="updateCategory('{{ place.name }}', this)">
                            식당
                        </label>
                        <button onclick="removeItem('{{ place.name }}')">삭제</button>
                    </li>
                {% endfor %}
            </ul>
        </div>

        <!-- 중간: 검색된 장소 리스트 -->
        <div id="resultContainer">
            <h3>검색 결과</h3>
            {% if results %}
                <ul>
                    {% for item in results %}
                        <li class="result-item" 
                            onclick="removeAllMarkers(); 
                                    addToList('{{ item.title | replace('<b>', '') | replace('</b>', '') }}', 
                                        '{{ ( item.mapx| float) /10000000 }}', 
                                        '{{ ( item.mapy | float) /10000000 }}', 
                                        '{{ item.roadAddress }}')">
                            <strong>이름:</strong> {{ item.title | safe }}<br>
                            <strong>주소:</strong> {{ item.address }}<br>
                            <strong>도로명 주소:</strong> {{ item.roadAddress }}<br>
                        </li>
                    {% endfor %}
                </ul>
            {% endif %}
        </div>

        <!-- 오른쪽: 지도 -->
        <div id="map"></div>
    </div>

    <button class="find-route-btn">최적의 경로 찾기</button>

    <script>
        var map;
        var markers = {}; // 이름을 키로 사용하여 마커를 관리
        var selectedPlaces = []; // 선택된 장소들을 저장할 배열
    
        function initMap() {
            console.log("initMap: 지도 초기화 중...");
            map = new naver.maps.Map('map', {
                center: new naver.maps.LatLng(37.751853, 128.876057), // 강릉 좌표
                zoom: 12
 
        function removeMarker(name) {
            if (markers[name]) {
                markers[name].setMap(null); // 지도에서 마커 제거
                delete markers[name]; // markers 객체에서 제거
            } else {
                console.warn(`No marker found for ${name}.`);
            }
        }
    
        function updateCategory(name, checkbox) {
            // 체크박스 상태에 따라 카테고리 값 수정
            for (let place of selectedPlaces) {
                if (place.name === name) {
                    place.category = checkbox.checked ? "1" : "0"; // 체크된 상태일 때 "1", 아니면 "0"
                    break;
                }
            }
        
            // 세션에 저장 및 results.json에 저장
            updateSession();
        }
        function removeAllMarkers() {
            console.log("모든 마커를 제거합니다...");
            for (let name in markers) {
                if (markers[name]) {
                    markers[name].setMap(null);  // 지도에서 마커 제거
                    delete markers[name];        // markers 객체에서 마커 제거
                }
            }
            console.log("모든 마커 제거 완료.");
        }
        function updateSession() {
            // 세션에 선택된 장소 정보 저장
            fetch('/save_results', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ selectedPlaces: selectedPlaces })
            });
        }
        
        window.onload = function () {
            console.log("window.onload 실행: 페이지 로드 완료");
            initMap();
            // 세션에서 선택된 장소 정보를 불러와서 표시
            const storedSelectedPlaces = {{ selected_places | tojson }};
            selectedPlaces = storedSelectedPlaces || [];
            selectedPlaces.forEach(place => {
                console.log(`Adding marker for: ${place.name}`);
                addMarker(place.name, parseFloat(place.lng), parseFloat(place.lat));
            });
        };
    </script>
</body>
</html>
