<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>강릉 여행지 검색</title>
    <script src="https://openapi.map.naver.com/openapi/v3/maps.js?ncpClientId=l10kq6x6md"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body>
    <h1>강릉 여행지 검색</h1>
    <div class="search-container">
        <form method="POST" onsubmit="return retainTravelList()">
            <input type="text" name="query" placeholder="검색어를 입력하세요">
            <button type="submit">검색</button>
        </form>
    </div>

    <div class="container">
        <!-- 왼쪽: 선택된 여행지 -->
        <div id="travelListContainer">
            <h3>선택된 여행지</h3>
            <ul id="travelList">
                {% for place in selected_places %}
                    <li>
                        {{ place.name }} 
                        <label>
                            <!-- 체크박스 상태가 변경될 때마다 updateCategory 호출 -->
                            <input type="checkbox" 
                            name="category_{{ place.name }}" 
                            value="1" 
                            {% if place.category == "1" %} checked {% endif %} 
                            onchange="updateCategory('{{ place.name }}', this)">
                            식당
                        </label>
                        <button onclick="removeItem('{{ place.name }}')">삭제</button>
                    </li>
                {% endfor %}
            </ul>
        </div>

        <!-- 중간: 검색된 장소 리스트 -->
        <div id="resultContainer">
            <h3>검색 결과</h3>
            {% if results %}
                <ul>
                    {% for item in results %}
                        <li class="result-item" onclick="addToList('{{ item.title | replace('<b>', '') | replace('</b>', '') }}', '{{ item.mapx }}', '{{ item.mapy }}', '{{ item.roadAddress }}')">
                            <strong>이름:</strong> {{ item.title | safe }}<br>
                            <strong>주소:</strong> {{ item.address }}<br>
                            <strong>도로명 주소:</strong> {{ item.roadAddress }}<br>
                        </li>
                    {% endfor %}
                </ul>
            {% endif %}
        </div>

        <!-- 오른쪽: 지도 -->
        <div id="map"></div>
    </div>

    <button class="find-route-btn">최적의 경로 찾기</button>

    <script>
        var map;
        var markers = [];
        var selectedPlaces = [];  // 선택된 장소들을 저장할 배열

        function initMap() {
            map = new naver.maps.Map('map', {
                center: new naver.maps.LatLng(37.751853, 128.876057), // 강릉 좌표
                zoom: 12
            });
        }

        function addToList(name, x, y, address) {
            const list = document.getElementById('travelList');
            const items = list.getElementsByTagName('li');
            for (let i = 0; i < items.length; i++) {
                if (items[i].textContent.includes(name)) {
                    return; // 중복된 항목 방지
                }
            }

            // 선택된 장소 배열에 추가
            selectedPlaces.push({
                name: name,
                address: address,
                category: "0"  // 기본적으로 식당으로 설정
            });

            const listItem = document.createElement('li');
            listItem.innerHTML = `${name} 
                <label>
                    <input type="checkbox" class="category-check" name="category_${name}" value="0" onchange="updateCategory('${name}', this)"> 식당
                </label>
                <button onclick="removeItem('${name}')">삭제</button>`;
            
            list.appendChild(listItem);
            addMarker(name, parseFloat(x), parseFloat(y));

            // 세션에 저장 및 results.json에 저장
            updateSession();
        }

        function addMarker(name, x, y) {
            if (isNaN(x) || isNaN(y)) {
                console.error('Invalid coordinates for marker:', name);
                return;
            }
            const position = new naver.maps.LatLng(y, x);
            const marker = new naver.maps.Marker({
                position: position,
                map: map,
                title: name
            });
            markers.push({ name: name, marker: marker });
            map.setCenter(position); // 지도 중심 변경
        }

        function removeItem(name) {
            // 선택된 장소에서 제거
            selectedPlaces = selectedPlaces.filter(place => place.name !== name);

            // 세션에 저장
            updateSession();

            // 목록에서 항목 제거
            const list = document.getElementById('travelList');
            const items = list.getElementsByTagName('li');
            for (let i = 0; i < items.length; i++) {
                if (items[i].textContent.includes(name)) {
                    list.removeChild(items[i]);
                    break;
                }
            }
        }

        function updateCategory(name, checkbox) {
            // 체크박스 상태에 따라 카테고리 값 수정
            for (let place of selectedPlaces) {
                if (place.name === name) {
                    place.category = checkbox.checked ? "1" : "0"; // 체크된 상태일 때 "1", 아니면 "0"
                    break;
                }
            }
        
            // 세션에 저장 및 results.json에 저장
            updateSession();
        }
        
        function updateSession() {
            // 세션에 선택된 장소 정보 저장
            fetch('/save_results', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ selectedPlaces: selectedPlaces })
            });
        }
        
        window.onload = function () {
            initMap();
            // 세션에서 선택된 장소 정보를 불러와서 표시
            const storedSelectedPlaces = {{ selected_places | tojson }};
            selectedPlaces = storedSelectedPlaces;
            selectedPlaces.forEach(place => {
                addToList(place.name, place.x, place.y, place.address);
            });
        };
    </script>
</body>
</html>
